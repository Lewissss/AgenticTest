{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ATF Trace v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "type",
    "testName",
    "description",
    "app",
    "baseUrl",
    "apiBaseUrl",
    "createdAt",
    "generator",
    "inputs",
    "policies",
    "steps"
  ],
  "properties": {
    "version": {
      "type": "integer",
      "const": 1
    },
    "type": {
      "type": "string",
      "enum": ["ui", "api"]
    },
    "testName": {
      "type": "string",
      "minLength": 1
    },
    "description": {
      "type": "string"
    },
    "app": {
      "type": "string",
      "minLength": 1
    },
    "baseUrl": {
      "type": "string",
      "format": "uri"
    },
    "apiBaseUrl": {
      "type": "string",
      "format": "uri"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time"
    },
    "generator": {
      "type": "object",
      "required": ["mode", "llmProvider", "llmModel"],
      "properties": {
        "mode": {
          "type": "string"
        },
        "llmProvider": {
          "type": "string"
        },
        "llmModel": {
          "type": "string"
        }
      }
    },
    "inputs": {
      "type": "object",
      "required": ["env"],
      "properties": {
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        }
      }
    },
    "policies": {
      "type": "object",
      "required": ["headless", "noMocks", "maxSteps", "timeoutsMs"],
      "properties": {
        "headless": {
          "type": "boolean"
        },
        "noMocks": {
          "type": "boolean"
        },
        "maxSteps": {
          "type": "integer",
          "minimum": 1
        },
        "timeoutsMs": {
          "type": "integer",
          "minimum": 1000
        }
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "action", "selectorOrEndpoint"],
        "properties": {
          "id": {
            "type": "string"
          },
          "action": {
            "type": "string",
            "enum": [
              "navigate",
              "click",
              "input",
              "select",
              "press",
              "waitForText",
              "waitForSelector",
              "extractText",
              "get",
              "post",
              "put",
              "patch",
              "delete"
            ]
          },
          "selectorOrEndpoint": {
            "type": "string"
          },
          "input": {
            "oneOf": [
              { "type": "string" },
              { "type": "object" },
              { "type": "null" }
            ]
          },
          "expected": {
            "type": "object",
            "default": {},
            "additionalProperties": true
          },
          "guards": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "expectUrlIncludes": { "type": "string" },
              "expectTextIncludes": {
                "oneOf": [
                  { "type": "string" },
                  {
                    "type": "array",
                    "items": { "type": "string" }
                  }
                ]
              },
              "expectStatusCode": { "type": "integer" },
              "allowRetry": { "type": "boolean" },
              "timeoutMs": { "type": "integer", "minimum": 0 }
            }
          }
        }
      }
    }
  }
}
